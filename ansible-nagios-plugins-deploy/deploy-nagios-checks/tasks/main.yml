#SPDX-License-Identifier: MIT-0
---
# tasks file for deploy-role

- name: Set build packages for RedHat family
  ansible.builtin.set_fact:
    nagios_plugins_build_packages: "{{ nagios_plugins_build_packages_redhat }}"
  when: ansible_facts['os_family'] == "RedHat"

- name: Set build packages for Debian family
  ansible.builtin.set_fact:
    nagios_plugins_build_packages: "{{ nagios_plugins_build_packages_debian }}"
  when: ansible_facts['os_family'] == "Debian"

- name: Install build dependencies
  ansible.builtin.package:
    name: "{{ nagios_plugins_build_packages }}"
    state: present
  become: true

- name: Create build directory
  ansible.builtin.file:
    path: "{{ nagios_plugins_build_dir }}"
    state: directory
    mode: '0755'

- name: Clone nagios-plugins repository
  ansible.builtin.git:
    repo: "{{ nagios_plugins_repo }}"
    dest: "{{ nagios_plugins_build_dir }}"
    version: "{{ nagios_plugins_version }}"
    force: true
    depth: 1

- name: Run tools/setup to initialize build system
  ansible.builtin.command:
    cmd: ./tools/setup
    chdir: "{{ nagios_plugins_build_dir }}"
    creates: "{{ nagios_plugins_build_dir }}/configure"

- name: Run configure script
  ansible.builtin.command:
    cmd: >
      ./configure
      --prefix={{ nagios_plugins_install_prefix }}
      --with-cgiurl={{ nagios_plugins_cgi_url }}
    chdir: "{{ nagios_plugins_build_dir }}"
    creates: "{{ nagios_plugins_build_dir }}/Makefile"

- name: Compile nagios plugins
  ansible.builtin.command:
    cmd: make -j{{ ansible_processor_vcpus | default(2) }}
    chdir: "{{ nagios_plugins_build_dir }}"
    creates: "{{ nagios_plugins_build_dir }}/plugins/check_http"

- name: Create installation directory
  ansible.builtin.file:
    path: "{{ nagios_plugins_install_prefix }}"
    state: directory
    mode: '0755'
  become: true

- name: Install nagios plugins
  ansible.builtin.command:
    cmd: make install
    chdir: "{{ nagios_plugins_build_dir }}"
    creates: "{{ nagios_plugins_install_prefix }}/libexec/check_http"
  become: true

- name: Install setuid plugins (requires root)
  ansible.builtin.command:
    cmd: make install-root
    chdir: "{{ nagios_plugins_build_dir }}"
  become: true
  register: install_root_result
  changed_when: install_root_result.rc == 0
  failed_when: false  # Don't fail if no setuid plugins need installation

- name: Verify installation
  ansible.builtin.stat:
    path: "{{ nagios_plugins_install_prefix }}/libexec/check_http"
  register: check_http_stat
  failed_when: not check_http_stat.stat.exists

- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "Nagios plugins {{ nagios_plugins_version }} installed successfully"
      - "Installation directory: {{ nagios_plugins_install_prefix }}"
      - "Plugin directory: {{ nagios_plugins_install_prefix }}/libexec"
